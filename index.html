<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HomeWorkSnap ‚Äì MVP Prototype</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #fff7e8;
        margin: 0; padding: 0;
        color: #1c1c1c;
    }
    header {
        background: white;
        border-bottom: 1px solid #ffd9b3;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    header .logo {
        font-weight: bold;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    header .logo span {
        font-size: 24px;
    }
    header .score {
        text-align: right;
        font-size: 12px;
        line-height: 1.3;
    }
    #container {
        padding: 20px;
        max-width: 800px;
        margin: auto;
        text-align: center;
    }
    h2 {
        margin-top: 10px;
        margin-bottom: 6px;
    }
    p.subtitle {
        margin-top: 0;
        font-size: 14px;
        color: #444;
    }
    button {
        padding: 12px 22px;
        border-radius: 25px;
        border: none;
        font-size: 15px;
        cursor: pointer;
        font-weight: bold;
    }
    .primary {
        background: linear-gradient(90deg,#ff8a2a,#ff6b1a);
        color: white;
    }
    .secondary {
        background: #fff;
        border: 1px solid #ffe0c2;
        color: #444;
    }
    .box {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #ffd9b3;
        text-align: left;
    }
    input[type="file"] {
        margin-top: 10px;
    }
    textarea {
        width: 100%;
        height: 120px;
        margin-top: 10px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ffd9b3;
        box-sizing: border-box;
    }
    pre {
        white-space: pre-wrap;
        text-align: left;
        background: #fff3e0;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ffd9b3;
        font-size: 13px;
    }
    .flex {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }
    .flex > div {
        flex: 1;
        min-width: 260px;
    }
    .kid-step {
        background: #fffdf7;
        border-radius: 10px;
        padding: 10px 12px;
        border: 1px dashed #ffb45c;
        font-size: 14px;
    }
    .small-label {
        font-size: 11px;
        color: #777;
    }
</style>
</head>
<body>

<header>
    <div class="logo">
        <span>üì∏</span> <div>HomeWorkSnap</div>
    </div>
    <div class="score">
        <div><strong>Snap Points:</strong> <span id="points">0</span></div>
        <div><strong>Streak:</strong> <span id="streak">0</span> days</div>
        <div class="small-label">üêøÔ∏è Snappy is cheering you on!</div>
    </div>
</header>

<div id="container">

    <h2>What if homework time didn‚Äôt end in tears?</h2>
    <p class="subtitle">
        Snap a homework problem ‚Üí AI turns it into a parent explanation and kid-friendly steps.
        <br>
        <span style="font-size:12px;color:#777;">
            Unlike generic AI, HomeWorkSnap teaches <b>how to think</b>, not just ‚Äúhere‚Äôs the answer.‚Äù
        </span>
    </p>

    <div class="box">
        <label><b>Your OpenAI API Key:</b></label>
        <input type="password" id="apikey" placeholder="sk-..." 
               style="width:100%;padding:10px;border-radius:10px;margin-top:8px;border:1px solid #ffd9b3;box-sizing:border-box;">
        <div class="small-label" style="margin-top:4px;">
            Key is only used locally in your browser for this prototype.
        </div>
    </div>

    <div class="box">
        <label><b>Upload Homework Image</b></label><br>
        <input type="file" id="imageInput" accept="image/*">
        <p style="font-size:12px;color:#555;">OR paste text below:</p>
        <textarea id="textInput" placeholder="Paste homework text here..."></textarea>

        <button class="primary" onclick="generate()">Explain Homework</button>
    </div>

    <div id="result" class="box" style="display:none;">
        <div class="flex">
            <div>
                <h3>Parent Explanation</h3>
                <pre id="parentOut"></pre>
            </div>
            <div>
                <h3>Kid Mode ‚Äì Step <span id="kidStepNumber">0</span></h3>
                <div class="kid-step" id="kidStepText">Run an explanation first.</div>
                <div class="small-label" id="kidCheckQuestion" style="margin-top:6px;"></div>
                <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="secondary" id="prevStepBtn" onclick="prevKidStep()" disabled>‚Üê Previous</button>
                    <button class="primary" id="nextStepBtn" onclick="nextKidStep()">Next step ‚Üí</button>
                    <button class="secondary" id="finishBtn" onclick="finishSnap()" style="display:none;">
                        I finished this Snap ‚úÖ
                    </button>
                </div>
            </div>
        </div>

        <div style="margin-top:20px;">
            <h3>Final Answer</h3>
            <pre id="finalOut"></pre>

            <h3>Reflection Question</h3>
            <pre id="reflectOut"></pre>
        </div>
    </div>

</div>

<script>
let currentKidSteps = [];
let currentKidIndex = 0;
let snapCompleted = false;

function loadScores() {
    const pts = parseInt(localStorage.getItem("hws_points") || "0", 10);
    const streak = parseInt(localStorage.getItem("hws_streak") || "0", 10);
    document.getElementById("points").innerText = pts;
    document.getElementById("streak").innerText = streak;
}

function saveScores(points, streak, lastDate) {
    localStorage.setItem("hws_points", String(points));
    localStorage.setItem("hws_streak", String(streak));
    localStorage.setItem("hws_lastDate", lastDate);
}

function todayString() {
    const d = new Date();
    return d.toISOString().slice(0,10); // YYYY-MM-DD
}

function isYesterday(lastDate) {
    if (!lastDate) return false;
    const d = new Date(lastDate);
    d.setDate(d.getDate() + 1);
    const tomorrowOfLast = d.toISOString().slice(0,10);
    return tomorrowOfLast === todayString();
}

loadScores();

async function generate() {
    const apiKey = document.getElementById("apikey").value;
    if (!apiKey) return alert("Enter your OpenAI key first!");

    let text = document.getElementById("textInput").value.trim();

    if (!text) {
        const fileInput = document.getElementById("imageInput").files[0];
        if (!fileInput) return alert("Upload an image or paste text!");
        text = await extractTextFromImage(fileInput);
    }

    snapCompleted = false; // reset for new problem

    const prompt = `
You are an expert educator and tutor.

Explain this homework problem to:
1) The parent
2) A kid age 7‚Äì12

Homework:
${text}

Return JSON exactly like:
{
  "parent": "Explanation for the parent...",
  "kid_steps": [
    {
      "title": "Short title",
      "instruction": "Short kid-friendly instruction.",
      "check_question": "Tiny check question for the child."
    }
  ],
  "final_answer": "Answer",
  "reflection": "Question child should think about"
}
`;

    const response = await fetch("https://api.openai.com/v1/responses", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
        },
        body: JSON.stringify({
            model: "gpt-4.1-mini",
            input: prompt,
            response_format: {type:"json_object"}
        })
    });

    const data = await response.json();
    console.log("OpenAI raw:", data);

    let textContent = "";
    try {
        // Responses API style
        textContent = data.output[0].content[0].text;
    } catch(e) {
        // fallback if shape changes
        textContent = data.output_text || JSON.stringify(data);
    }

    let parsed;
    try {
        parsed = JSON.parse(textContent);
    } catch(e) {
        alert("Could not parse AI response. Check console.");
        console.error("Parse error", e, textContent);
        return;
    }

    document.getElementById("parentOut").innerText = parsed.parent || "";
    document.getElementById("finalOut").innerText = parsed.final_answer || "";
    document.getElementById("reflectOut").innerText = parsed.reflection || "";

    currentKidSteps = parsed.kid_steps || [];
    currentKidIndex = 0;
    updateKidStep();

    document.getElementById("result").style.display = "block";
}

function updateKidStep() {
    const kidStepNumber = document.getElementById("kidStepNumber");
    const kidStepText = document.getElementById("kidStepText");
    const kidCheck = document.getElementById("kidCheckQuestion");
    const prevBtn = document.getElementById("prevStepBtn");
    const nextBtn = document.getElementById("nextStepBtn");
    const finishBtn = document.getElementById("finishBtn");

    if (!currentKidSteps.length) {
        kidStepNumber.innerText = "0";
        kidStepText.innerText = "No steps yet. Run an explanation.";
        kidCheck.innerText = "";
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        finishBtn.style.display = "none";
        return;
    }

    const step = currentKidSteps[currentKidIndex];
    kidStepNumber.innerText = currentKidIndex + 1;
    kidStepText.innerText = (step.title ? step.title + " ‚Äì " : "") + (step.instruction || "");
    kidCheck.innerText = step.check_question ? "Quick check: " + step.check_question : "";

    prevBtn.disabled = currentKidIndex === 0;
    const lastIndex = currentKidSteps.length - 1;
    if (currentKidIndex === lastIndex) {
        nextBtn.disabled = true;
        finishBtn.style.display = "inline-block";
    } else {
        nextBtn.disabled = false;
        finishBtn.style.display = "none";
    }
}

function nextKidStep() {
    if (currentKidIndex < currentKidSteps.length - 1) {
        currentKidIndex++;
        updateKidStep();
    }
}

function prevKidStep() {
    if (currentKidIndex > 0) {
        currentKidIndex--;
        updateKidStep();
    }
}

function finishSnap() {
    if (snapCompleted) {
        alert("This Snap is already counted. Great job!");
        return;
    }
    snapCompleted = true;

    let points = parseInt(localStorage.getItem("hws_points") || "0", 10);
    let streak = parseInt(localStorage.getItem("hws_streak") || "0", 10);
    const lastDate = localStorage.getItem("hws_lastDate");
    const today = todayString();

    points += 10; // +10 per completed Snap

    if (lastDate === today) {
        // streak unchanged, already counted today
    } else if (isYesterday(lastDate)) {
        streak += 1;
    } else {
        streak = 1;
    }

    saveScores(points, streak, today);
    loadScores();

    alert("Snap completed! üéâ +10 points for effort.\nSnappy is proud of you.");
}

async function extractTextFromImage(file) {
    // Simple placeholder: real OCR can be added later
    return "Image uploaded, but OCR is not wired yet in this prototype. Paste text instead for now.";
}
</script>

</body>
</html>
